--MSSV: 20127392
--Mã đề: 04
--Vị trí: (2,8)

--B1: TẠO CƠ SỞ DỮ LIỆU 
USE master
GO
IF DB_ID ('QLHOKHAU') IS NOT NULL
	DROP DATABASE QLHOKHAU
GO
CREATE DATABASE QLHOKHAU
GO
USE QLHOKHAU
GO
--B2: TẠO BẢNG VÀ KHÓA CHÍNH
CREATE TABLE NGUOIDAN
(
	MAND VARCHAR(5),
	HOTEN NVARCHAR(50),
	NGAYSINH DATE,
	DIENTHOAI VARCHAR(50),
	TRINHDO NVARCHAR(50)

	CONSTRAINT PK_NGUOIDAN
	PRIMARY KEY(MAND)
)

CREATE TABLE HODAN
(
	MAHODAN VARCHAR(5),
	DIACHI NVARCHAR(50),
	CHUHO VARCHAR(5),
	DIENTHOAI VARCHAR(50),
	MAKHUPHO VARCHAR(10)

	CONSTRAINT PK_HODAN
	PRIMARY KEY(MAHODAN)
)

CREATE TABLE KHUPHO
(
	MAKP VARCHAR(10),
	TENKHUPHO NVARCHAR(50),
	TRUONGKHUPHO VARCHAR(5)

	CONSTRAINT PK_KHUPHO
	PRIMARY KEY(MAKP)
)

CREATE TABLE CT_HODAN
(
	MAHODAN VARCHAR(5),
	MAKP VARCHAR(10),
	MAND VARCHAR(5),
	TINHTRANG NVARCHAR(50)

	CONSTRAINT PK_CT_HODAN
	PRIMARY KEY(MAHODAN,MAKP,MAND)
)

--B3: TẠO KHÓA NGOẠI
ALTER TABLE HODAN
ADD
	CONSTRAINT FK_HD_CT_HODAN
	FOREIGN KEY(MAHODAN,MAKHUPHO,CHUHO)
	REFERENCES CT_HODAN,
	CONSTRAINT FK_HD_KP
	FOREIGN KEY(MAKHUPHO)
	REFERENCES KHUPHO,
	CONSTRAINT FK_HD_ND
	FOREIGN KEY(CHUHO)
	REFERENCES NGUOIDAN

ALTER TABLE KHUPHO
ADD
	CONSTRAINT FK_KP_ND
	FOREIGN KEY(TRUONGKHUPHO)
	REFERENCES NGUOIDAN

ALTER TABLE CT_HODAN
ADD
	CONSTRAINT FK_CT_HODAN_KP
	FOREIGN KEY(MAKP)
	REFERENCES KHUPHO,
	CONSTRAINT FK_CT_HODAN_ND
	FOREIGN KEY(MAND)
	REFERENCES NGUOIDAN

--B4: NHẬP DỮ LIỆU
INSERT NGUOIDAN(MAND,HOTEN,NGAYSINH,DIENTHOAI,TRINHDO)
VALUES('ND01', N'Lê Thị Lựu', '2000-12-1', '0909332123', N'Đại học'),
('ND02', N'Trương Minh Sang', '2001-12-31', '0989009767' ,N'Trung học'),
('ND03' ,N'Phạm Minh Thi' ,Null, Null ,N'Tiến sĩ')

INSERT HODAN(MAHODAN,DIACHI,CHUHO,DIENTHOAI,MAKHUPHO)
VALUES ('HD01',N'45 Nguyễn Cư Trinh Q1', 'ND01', '0289881112', 'KP1-Q1'),
('HD01', N'12 Nguyễn Văn Luông Q6', 'ND01', Null, 'KP10-Q6'),
('HD03', N'125 Nguyễn Văn Cừ Q5', 'ND03', Null, 'KP3-Q5')

INSERT KHUPHO(MAKP,TENKHUPHO,TRUONGKHUPHO)
VALUES ('KP1-Q1', N'Khu phố 1 – Quận 1', 'ND02'),
('KP10-Q6' ,N'Khu phố 10 – Quận 6', 'ND03'),
('KP3-Q5', N'Khu phố 3 – Quận 5' ,null)

INSERT CT_HODAN(MAHODAN,MAKP,MAND,TINHTRANG)
VALUES ('HD01', 'KP1-Q1','ND01', N'Thường trú'),
('HD01', 'KP10-Q6', 'ND03', N'Tạm trú'),
('HD03', 'KP3-Q5' ,'ND03' ,N'Thường trú')

-- TRUY VẤN
--Q4--
SELECT ND1.*,ND2.*
FROM NGUOIDAN ND1,CT_HODAN CT,NGUOIDAN ND2
WHERE CT.TINHTRANG=N'Tạm trú' AND CT.MAKP='%Q6' AND ND1.MAND=CT.MAND
	AND CT.TINHTRANG=N'Thường trú' AND ND2.MAND=CT.MAND 
